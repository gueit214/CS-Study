## 브라우저 렌더링 과정

1. 브라우저는 HTML, CSS, Javascript, 이미지, 폰트 파일 등 렌더링에 필요한 리소스를 요청하고 서버로부터 응답 받는다.
2. 브라우저의 렌더링 엔진은 서버로부터 응답된 HTML과 CSS를 파싱하여 `DOM과 CSSOM`을 생성하고 이들을 결합하여 렌더 트리를 생성한다.

   - 각각 HTML parser, CSS parser에 의해 그려진다.
   - **DOM** : 웹 브라우저와 Javascript가 HTML을 이해하기 쉽도록 트리 구조로 파싱하여 만든 객체

     ```js
     <!doctype html>
     <html lang='ko'>
      <head>
        <title>My first web page</title>
      </head>
      <body>
        <h1>Hello, world!</h1>
        <p>My first web page</p>
      </body>
     </html>
     ```

     위 HTML 문서는 다음과 같은 DOM 트리로 파싱된다.

     <img src='https://velog.velcdn.com/images%2Fjuno7803%2Fpost%2F5d008904-f9e3-40fb-8f88-d7cee134d8f0%2Fimage.png'/>

   - **CSSOM** : DOM에 CSS가 적용된 객체 모델

3. 브라우저의 자바스크립트 엔진은 서버로부터 응답된 자바스크립트를 파싱하여 AST를 생성하고 바이트 코드로 변환하여 실행한다. 이때 자바스크립트는 DOM API를 통해 DOM이나 CSSOM을 변경할 수 있다. 변경된 DOM과 CSSOM은 다시 `렌더 트리로 결합`된다.
4. 렌더 트리를 기반으로 HTML 요소의 레이아웃을 계산하고 브라우저 화면에 HTML 요소를 페인팅한다.

- **브라우저** : 인터넷에서 웹서버의 모든 정보를 볼 수 있게 해줄 뿐 아니라, 하이퍼텍스트 문서 검색을 도와주는 응용 프로그램

- **파싱** : 텍스트 문서의 문자열을 토큰으로 분해하고, 토큰에 문법적 의미와 구조를 반영하여 parse tree(구문 분석 트리)를 생성하는 과정

## 요청과 응답

- 브라우저의 핵심 기능은 필요한 리소스를 서버에 요청하고 서버로부터 응답 받아 브라우저에 시각적으로 렌더링하는 것이다. 렌더링에 필요한 리소스는 모두 서버에 존재하므로 필요한 리소스를 서버에 요청하고 서버가 응답한 리소스를 파싱하여 렌더링한다.
- 서버에 요청을 전송하기 위해 브라우저는 주소창을 제공한다.
- 브라우저 주소창에 URL을 입력하여 엔터를 누르면 URL의 호스트 이름이 DNS를 통해 IP 주소로 변환되고 이 IP 주소를 갖는 서버에게 요청을 전송한다.
- 서버는 루트(/) 요청에 대해 암묵적으로 index.html을 응답하도록 설정되어 있다. ( [https://naver.com](https://naver.com) → [https://naver.com/index.html](https://naver.com/index.html) )
- index.html을 파싱하는 도중에 외부 리소스를 로드하는 태그(link, img, script 등)를 만나면 HTML의 파싱을 일시 중단하고 해당 리소스 파일을 서버로 요청한다. ( 개발자도구 Network 확인 가능)

## HTTP 1.1과 HTTP 2.0

- HTTP는 웹에서 브라우저와 서버가 통신하기 위한 프로토콜이다.
- HTTP 1.1은 커넥션당 하나의 요청과 응답만 처리한다.
- HTTP 2.0은 커넥션당 여러 개의 요청과 응답이 가능하다.

## HTML 파싱과 DOM 생성

- 브라우저 요청에 의해 서버가 응답한 HTML 문서는 문자열로 이루어진 순수한 텍스트다.
- 브라우저의 렌더링 엔진은 바이트 → 문자 → 토큰 → 노드 → DOM 과정을 통해 응답받은 HTML 문서를 파싱하여 브라우저가 이해할 수 있는 자료구조인 DOM을 생성한다.

## CSS 파싱과 CSSOM 생성

- 렌더링 엔진은 DOM을 생성해 나가다가 CSS를 로드하는 link 태그나 style 태그를 만나면 DOM을 일시 중단하고 CSS 파일을 서버에 요청한다.
- CSS 파일이나 style 태그 내의 CSS를 바이트 → 문자 → 토큰 → 노드 → CSSOM 과정을 통해 CSSOM을 생성한다.
- CSS 파싱이 완료되면 HTML 파싱이 중단된 지점부터 다시 HTML 파싱하기 시작하여 DOM을 생성한다.

## 렌더 트리 생성

- 렌더링 엔진이 생성한 DOM과 CSSOM은 렌더링을 위해 렌더 트로로 결합된다.
- 브라우저 화면에 렌더링 되는 노드만으로 구성된다. (meta, script, display:none 등은 제외)
- 완성된 렌더 트리는 각 HTML 요소의 레이아웃을 계산하는 데 사용되며 브라우저 화면에 픽생을 렌더링하는 페이팅 처리에 입력된다.

## 자바스크립트 파싱과 실행

- 렌더링 엔진은 DOM을 생성해 나가다가 자바스크립트 파일을 로드하는 script 태그를 만나면 DOM 생성을 일시 중단한다.
- 자바스크립트 코드를 파싱하기 위해 브라우저 렌더링 엔진에서 자바스크립트 엔진으로 제어권을 넘긴다.
- 자바스크립트 코드에서 DOM API를 사용하여 DOM을 조작한다.
- 자바스크립트 엔진은 자바스크립트를 해석하여 AST를 생성하고 AST 기반으로 바이트코드를 생성하여 실행한다.

(자바스크립트 코드 → 토큰 → AST → 바이트 코드)

## 리플로우와 리페인트

- DOM API가 사용된 경우DOM이나 CSSOM이 변경된다.
- 변경된 DOM과 CSSOM은 다시 렌더 트리로 결합되고 변경된 레이아웃을 계산하는 것을 리플로우, 렌더 트리를 기반으로 다시 페인트 하는 것을 리페인트라고 한다.

## 자바스크립트 파싱에 의한 HTML 파싱 중단

- 브라우저는 동기적으로 실행되기 때문에, script 태그는 body 요소의 가장 아래에 위치 시키는 것이 좋다.
- script 태그의 async/defer 어트리뷰트를 이용하면 HTML 파싱과 외부 자바스크립트 파일을 로드가 비동기적으로 동시에 진행되게 할 수 있다. (하지만 자바스크립트 실행 시점에 차이가 있음)

## 참고

- 네이버 지식백과 (파싱, 브라우저)
- 자바스크립트 딥 다이브 38장 브라우저의 렌더링 과정
